server {
    listen 3001;
    server_name localhost;

    root /usr/share/nginx/html;
    index index.html;

    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_proxied any;
    gzip_types text/plain text/css text/xml text/javascript application/javascript application/json application/xml;

    # Cache static assets
    location /assets/ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # Tailscale identity endpoint
    # When served via Tailscale Serve, it injects identity headers:
    # - Tailscale-User-Login: User's login (e.g., alice@example.com)
    # - Tailscale-User-Name: Display name
    # - Tailscale-User-Profile-Pic: Profile picture URL
    location /api/tailscale/identity {
        default_type application/json;

        # Extract Tailscale headers (nginx converts to lowercase with underscores)
        set $ts_login $http_tailscale_user_login;
        set $ts_name $http_tailscale_user_name;
        set $ts_pic $http_tailscale_user_profile_pic;

        # Determine if authenticated (login header present)
        set $is_auth "false";
        if ($ts_login != "") {
            set $is_auth "true";
        }

        # Return JSON response with identity info
        # Note: Using single quotes to avoid JSON escaping issues
        return 200 '{"login":"$ts_login","name":"$ts_name","profilePic":"$ts_pic","isAuthenticated":$is_auth}';
    }

    # SPA fallback - serve index.html for all routes
    location / {
        try_files $uri $uri/ /index.html;
    }

    # Health check
    location /health {
        return 200 '{"status":"ok"}';
        add_header Content-Type application/json;
    }
}
